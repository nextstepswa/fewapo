---
title: "Homicides by Police in WA since 2015"
subtitle: "Next Steps Washington"
author: "Everyone Comes Home Alive"
date: "Last report update: `r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    includes:
       in_header: gtag.2015.html
params:
  from: ["I-940"]
  startyr: [2019]
  rdafile: ["WA940.rda"]
  caption: ["WA since I-940"]
  smooth_span: [0.8]
---

<base target="_top"/>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, fig.height = 4)
```

```{r prelim, warning=F}
library(tidyverse)
library(plotly)
library(kableExtra)
library(here)
library(leaflet)
library(lubridate)


# get cleaned, merged data for WA
load(file = here("data-outputs", params$rdafile))

# Data prep (common)
source(here("Analyses", "Common", "waAnalysesPrep.R"))

# for geocoded LDs
with(homicides, write.csv(cbind(feID,latitude,longitude),
                          here("data-outputs",
                               "geocodes940.csv")))

```

# Introduction {.tabset}

After winning over 60% of the statewide vote, Initiative 940 was passed into WA state law on December 6, 2018.  Then, during the 2021 legislative session (Jan - April) over a dozen bills were passed on a range of issues relating to police reform.  This report tracks the number of persons killed by police in WA state from `r params$from` to the most recent complete month, to show the trends before and after these changes.


## MOST RECENT DATA UPDATE (`r last_data_update`):


* __Total homicides by police since `r params$from`: 
`r last.case`__

* __Last reported case: 
`r last.name`, age `r last.age`, on `r last.date` by `r last.agency`__

    `r ifelse(last.name == "(Name not released)", "This", last.name)` is the `r paste0(tot.this.yr, num.suffix)` person killed by police in `r tot.yr.is`.  The cause of death is reported as `r last.cod`.  `r last.url`

During the last decade, one out of every 5 persons killed in Washington state has been killed by a law enforcement officer.  (Roughly 250 homicide deaths are recorded each year in WA State.  You can find the state's death data
<a href="https://www.doh.wa.gov/DataandStatisticalReports/HealthDataVisualization/MortalityDashboards/ACHInjuryDeathsDashboards" target="_top">here</a>).

___


```{r child='./Common/dataSourcesIntro.Rmd'}
```


```{r child='./Common/homicideDefinition.Rmd'}
```


# Interactive Map

You can click the numbered circles to reach the individual map pointers for each person killed by police.  

* _Hovering_ over the pointer brings up the name of the person killed and agency of the officer who killed them; 

* _Clicking_ the pointer will bring up a url to a news article on the case (if available).

```{r map, message=F, warning=F}
map <- leaflet(data = homicides, width = "100%") %>% 
  addTiles() %>%
  addMarkers( ~ longitude,
              ~ latitude,
              popup = ~ url_click,
              label = ~ as.character(paste(name, "by", agency)),
              clusterOptions = markerClusterOptions())
map
```


# Breakdowns

## Race {.tabset}

### Table

The race of the victim is missing in 
`r scales::percent(prop.table(table(homicides$raceOrig, 
useNA = "al"))[["Unknown"]])`
of the original data.  Fatal Encounters employs an algorithm to try to impute these cases.  Over half of the missing values are successfully imputed.  These imputations are included in the analysis here.
```{r racetab}

tab <- homicides %>%
  mutate(raceImp = recode(raceImp,
    "API" = "Asian/Pacific Islander",
    "BAA" = "Black/African American",
    "HL" = "Hispanic/Latinx",
    "NAA" = "Native American/Indigenous",
    "WEA" = "White/European American")
  ) %>%
group_by(raceImp) %>%
  summarize(Number = n(),
            Percent = round(100*Number/nrow(homicides), 1)
  ) %>%
  bind_rows(data.frame(raceImp="Total", 
                       Number = sum(.$Number), 
                       Percent = sum(.$Percent))) %>%
  rename(Race = raceImp) 

tab %>%
  kable(caption = "Breakdown by Race") %>%
  kable_styling(bootstrap_options = c("striped","hover")) %>%
  row_spec(row=dim(tab)[1], bold = T) %>%
  add_footnote(label = "Percents may not sum to 100 due to rounding",
               notation = "symbol")
```

### Plots
```{r raceplots, message=F}  
homicides %>%
  mutate(raceImp = recode(raceImp,
    "API" = "Asian",
    "BAA" = "Black",
    "HL" = "Latinx",
    "NAA" = "Native American",
    "WEA" = "White")
  ) %>%
  count(raceImp) %>%
  mutate(perc = n / nrow(homicides)) %>%
  ggplot(aes(x=raceImp, 
             y = perc, 
             label = n)) +
  # label = round(100*perc, 1))) +
  geom_bar(stat="identity", fill="blue", alpha=.5) +
  geom_text(aes(y = perc), size = 3, nudge_y = .025) +
  labs(title = "Fatalities by Race",
       caption = paste0("WA State since ", 
                        params$from, 
                        "; y-axis=pct, bar label=count")) +
         xlab("Reported Race") +
         ylab("Percent of Total")

homicides %>%
  mutate(raceb = case_when(raceImp == "WEA" ~ "White",
                           raceImp == "Unknown" ~ "Unknown",
                           TRUE ~ "BIPOC"),
         raceb = fct_relevel(raceb, "Unknown", 
                             after = Inf)) %>%
  count(raceb) %>%
  mutate(perc = n / nrow(homicides)) %>%
  ggplot(aes(x=raceb, 
             y = perc, 
             label = n)) +
  geom_text(aes(y = perc), size = 3, nudge_y = .025) +
  geom_bar(stat="identity", fill="blue", alpha=.5) +
  labs(title = "Fatalities by Race",
       caption = paste0("WA State since ", 
                        params$from, 
                        "; y-axis=pct, bar label=count")) +
  xlab("Reported Race") +
  ylab("Percent of Total")
```

____

```{r child='./Common/raceDiscussion.Rmd'}
```


## Cause of death {.tabset}

### Plot

```{r codplot}
homicides %>%
  mutate(codb = case_when(cod.fe == "Gunshot" ~ "Gunshot",
                          TRUE ~ "Other")
         ) %>%
  count(codb) %>%
  mutate(perc = n / nrow(homicides)) %>%
  ggplot(aes(x=codb, 
             y = perc, 
             label = n)) +
  geom_text(aes(y = perc), size = 3, nudge_y = .025) +
  geom_bar(stat="identity", fill="blue", alpha=.5) +
  labs(title = "Fatalities by Cause of Death",
       caption = paste0("WA State since ", 
                        params$from, 
                        "; y-axis=pct, bar label=count")) +
  xlab("Reported Weapon Used by Police") +
  ylab("Percent of Total")
```

### Table
```{r codtab}
tab <- homicides %>%
  group_by(cod.fe) %>%
  summarize(Number = n(),
            Percent = round(100*Number/nrow(homicides), 1)
  ) %>%
  arrange(desc(Number)) %>%
  bind_rows(data.frame(cod.fe ="Total", 
                       Number = sum(.$Number), 
                       Percent = sum(.$Percent))) 

tab %>%
  kable(caption = "Breakdown by Cause of Death",
        col.names = c("Cause of Death", "Number", "Percent")) %>%
  kable_styling(bootstrap_options = c("striped","hover")) %>%
  row_spec(row=dim(tab)[1], bold = T)  %>%
  add_footnote(label = "Percents may not sum to 100 due to rounding",
               notation = "symbol")
```


## Alleged weapon {.tabset}

The source of this information is typically the initial press release or report to the media from the involved law enforcement agency; it has not been independently verified.  It should be interpreted as the *alleged* weapon status of the person who was killed.

The data come from the Post dataset, *so this is not available for the additional cases in Fatal Encounters*.  The additional cases in Fatal Encounters are included in the "Unknown" category in the plot and table below.


### Plot

```{r armedplot}
homicides %>%
  mutate(armed = case_when(
    is.na(armed.wapo) ~ "Unknown",
    armed.wapo == "undetermined" ~ "Unknown",
    armed.wapo == "gun" ~ "Gun",
    armed.wapo == "gun and car" ~ "Gun",
    armed.wapo == "knife" ~ "Edged Weapon",
    armed.wapo == "machete" ~ "Edged Weapon",
    armed.wapo == "sword" ~"Edged Weapon",
    armed.wapo == "unarmed" ~ "Unarmed",
    TRUE ~ "Other")
         ) %>%
  count(armed) %>%
  mutate(perc = n / nrow(homicides)) %>%
  ggplot(aes(reorder(armed, perc),
             y = perc, 
             label = n)) +
  geom_text(aes(y = perc), size = 3, nudge_y = .025) +
  geom_bar(stat="identity", fill="blue", alpha=.5) +
  labs(title = "Fatalities by Alleged Victim Weapon",
       caption = paste0("WA State since ", 
                        params$from, 
                        "; y-axis=pct, bar label=count")) +
  xlab("Alleged Weapon Used by Victim") +
  ylab("Percent of Total")
```

### Table

```{r armed}
tab <- homicides %>%
  mutate(armed.wapo = case_when(is.na(armed.wapo) ~ "Unknown",
                                armed.wapo == "undetermined" ~ "Unknown",
                                TRUE ~ armed.wapo),
         armed.wapo = fct_relevel(armed.wapo, "Unknown", 
                                  after = Inf)
  ) %>%
  group_by(armed.wapo) %>%
  summarize(Number = n(),
            Percent = round(100*Number/nrow(homicides), 1)
  ) %>%
  arrange(desc(Number)) %>%
  bind_rows(data.frame(armed.wapo ="Total", 
                       Number = sum(.$Number), 
                       Percent = sum(.$Percent)))

tab %>%
  kable(caption = "Breakdown by Report of Victim Weapon (data from WaPo only)",
        col.names = c("Armed", "Number", "Percent")) %>%
  kable_styling(bootstrap_options = c("striped","hover")) %>%
  row_spec(row=dim(tab)[1], bold = T)  %>%
  add_footnote(label = "Percents may not sum to 100 due to rounding",
               notation = "symbol")
```

## Bodycam

This information comes from the Post dataset, *so is missing for the additional cases in Fatal Encounters.*  These additional cases are listed as "Unknown" below.

```{r bodycam}
homicides %>%
  mutate(bodycam.wapo = ifelse(bodycam.wapo, "Yes", "No"),
         bodycam.wapo = tidyr::replace_na(bodycam.wapo, "Unknown"),
         bodycam.wapo = fct_relevel(bodycam.wapo, "Unknown", 
                             after = Inf)) %>%
  group_by(bodycam.wapo) %>%
  summarize(Number = n(),
            Percent = round(100*Number/nrow(homicides), 1)
  ) %>%
  bind_rows(data.frame(bodycam.wapo ="Total", 
                       Number = sum(.$Number), 
                       Percent = sum(.$Percent))) %>%
  kable(caption = "Breakdown by Bodycam",
        col.names = c("Bodycam", "Number", "Percent")) %>%
  kable_styling(bootstrap_options = c("striped","hover")) %>%
  row_spec(row=4, bold = T)  %>%
  add_footnote(label = "Percents may not sum to 100 due to rounding",
               notation = "symbol")
```

## County {.tabset}


### Plot

```{r countyplot}
homicides %>%
  group_by(county) %>%
  summarize(n = n(),
            perc = n / nrow(homicides)) %>%
  ggplot(aes(reorder(county, perc),
             y = perc, 
             label = n)) +
  geom_text(aes(y = perc), size = 3, nudge_y = .025) +
  geom_bar(stat="identity", fill="blue", alpha=.5) +
  labs(title = "County",
       caption = paste0("WA State since ", 
                        params$from, 
                        "; y-axis=pct, bar label=count")) +
  xlab("County where fatal encounter happened") +
  ylab("Percent of Total") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### Table
```{r countytab}

homicides %>%
  group_by(county) %>%
  summarize(Number = n(),
            Percent = round(100*Number/nrow(homicides), 1)
  ) %>%
  DT::datatable(rownames = F,
                caption = "Breakdown by County")

```

## Agency/PD involved

This information comes from Fatal Encounters.

```{r agency}

# tab <- homicides %>%
#   group_by(agency) %>%
#   summarize(Number = n(),
#             Percent = round(100*Number/nrow(homicides), 1)
#             ) %>%
#   arrange(desc(Number)) %>%
#   bind_rows(data.frame(agency ="Total", 
#                        Number = sum(.$Number), 
#                        Percent = sum(.$Percent))) 
# 
# tab %>%
#   kable(caption = "Breakdown by Agency/PD of Involved Officer",
#         col.names = c("Agency/PD", "Number", "Percent")) %>%
#   kable_styling(bootstrap_options = c("striped","hover")) %>%
#   row_spec(row=dim(tab)[1], bold = T) %>%
#   add_footnote(label = "Percents may not sum to 100 due to rounding",
#                notation = "symbol")

homicides %>%
  group_by(agency) %>%
  summarize(Number = n(),
            Percent = round(100*Number/nrow(homicides), 1)
  ) %>%
  DT::datatable(rownames = F,
                caption = "Breakdown by Agency/PD of Involved Officer")

```

## Online information availability

This information comes from Fatal Encounters.  It takes the form of a single url to a news article that is available online.  There are often multiple news articles available online, and they may report the conflicting details of the event, as well as conflicting perspectives on the justifiability of the use of lethal force.  

The clickable urls are available in this report in the [Interactive Map](#interactive-map) and [Say their names](#say-their-names) sections.  They should be treated as a place to start research, not as the definitive description of the event.

```{r info}

tab <- homicides %>%
  mutate(url_info = case_when(url_info == "" ~ "No",
                               is.na(url_info) ~ "No",
                               TRUE ~ "Yes")) %>%
  group_by(url_info) %>%
  summarize(Number = n(),
            Percent = round(100*Number/nrow(homicides), 1)
  ) %>%
  bind_rows(data.frame(url_info ="Total", 
                       Number = sum(.$Number), 
                       Percent = sum(.$Percent))) 

tab %>%
  kable(caption = "URL for news article in Fatal Encounters",
        col.names = c("Availability", "Number", "Percent")) %>%
  kable_styling(bootstrap_options = c("striped","hover")) %>%
  row_spec(row=dim(tab)[1], bold = T) %>%
  add_footnote(label = "Percents may not sum to 100 due to rounding",
               notation = "symbol")


```

<a id="mydate"></a>

# Trend over time

There are two sets of plots here.  The first focuses on the monthly totals, and how they have changed over time.  The second focuses on the cumulative totals as the year progresses, and how this has changed over time.


```{r monthdat, message=F, warning=F}

# index restricted to first/last complete month
thisyr <- as.character(max(index$year))
prevyrs <- paste0(min(index$year), "-", max(index$year)-1)

# left_join to index imposes same restriction
df_by_month <- homicides %>%
  group_by(year, month) %>%
  summarize(count = n()) %>%
  left_join(index, ., by = c("year", "mon"="month")) %>%
  mutate(count = tidyr::replace_na(count, 0),
         mo = match(mon, month.abb),
         mon = factor(mon, levels = month.abb),
         this.yr = factor(ifelse(year==max(year),
                                 thisyr,
                                 prevyrs),
                          levels = c(prevyrs, thisyr)))

yrs <- as.numeric(lubridate::ymd(
  paste0(seq(min(index$year), max(index$year), 1), 
         "-", start_mo, "-01")))

```

## Monthly totals {.tabset}

### Trend

* The points show the monthly totals, the grey line shows the smoothed average trend in monthly fatalities over time, and the grey shaded ribbon shows the 95% confidence interval around the trend line.

* We only plot months once the data are complete, so the plot will lag 1-2 months behind the current date.  

* This is an interactive plot:  You can hover over points to get the exact values for the number of cases for that month and year.


```{r series, warning=F}
# we will only plot after current month has finished

p <- ggplot(df_by_month, aes(x = index.date, 
                     y = count))  +
  geom_point(size=1.5, shape=21, stroke=0.25,
             aes(fill = factor(year),
                 text = paste0(mon, ": ", count))) +
  geom_smooth(span = params$smooth_span, col="grey")  +
  
  # year boundaries
  geom_vline(xintercept = yrs, col="white", alpha=.5) +
  
  geom_hline(yintercept = 0, col="grey") +
  
  labs(title = paste("Monthly fatalities:",
                     month.abb[start_mo], start_yr, " - ",
                     month.abb[last_complete_mo], max(index$year)),
       x = "Month/Year",
       y = "Number",
       caption = paste("WA since", params$startyr),
       fill = "Year") +
  
  ylim(c(-2, NA)) + # min needs to be < smoother lower se
  
  scale_x_continuous(
    breaks = df_by_month$index.date[seq(1, nrow(df_by_month), 6)],
    label = df_by_month$mon.yr[seq(1, nrow(df_by_month), 6)]
    )  +
  
  scale_y_continuous(breaks = c(0, 3, 6, 9, 12)) +
  
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggplotly(p, tooltip = "text") %>% 
  style(hoverinfo = "y", traces = 8)
  
```



### With key dates

This plot highlights key dates for legislation and legal actions related to police practices and accountability. 

* The $\color{blue}{\textsf{blue lines}}$ are legislative/regulatory actions  (940 legislation, 940 WACs, first bill passes in 2021, first & last bills signed by Gov 2021, legislation takes effect)

* The $\color{red}{\textsf{red lines}}$ are legal actions (Ellis investigation taken over by AGO, Nelson charged in Jesse Sarey case, 3 officers charged in Ellis case) 

* This is an interactive plot:  You can hover over points to get the number of cases for that month, and hovering at the top or bottom of the vertical lines will identify the action.

```{r keydates, warning=F}

p <- ggplot(df_by_month, 
            aes(x = index.date, y = count))  +
  geom_point(size=1.5, shape=21, stroke=0.25,
             aes(text = paste0(mon, ": ", count))) +
  geom_smooth(span = params$smooth_span, col="grey")  +
  
  # year boundaries
  geom_vline(xintercept = yrs, col="white", alpha=.5) +


  # reline y-axis in case yr[1] = start_date 
  geom_vline(aes(xintercept = as.numeric(start_date),
                 text = ""),
             col="grey", alpha=.8) +
  
  # key dates for prosecution
  geom_vline(aes(xintercept = as.numeric(date.ellis.ago),
                 text = "Ellis case taken over by AGO"),
             col="red", alpha=.8) +
  geom_vline(aes(xintercept = as.numeric(date.sarey.charged),
                 text = "Sarey case officer charged"),
             col="red", alpha=.8) +
  geom_vline(aes(xintercept = as.numeric(date.ellis.charged),
                 text = "Ellis case officers charged"),
             col="red", alpha=.8) +
  
  # key dates for legislation
  geom_vline(aes(xintercept = as.numeric(date.940.WAC), 
                 text = "940 WACs take effect"), 
             col="blue", alpha=.8) +
  geom_vline(aes(xintercept = as.numeric(date.firstbillpass), 
                 text = "First bill passes in session"), 
             col="blue", alpha=.8) +
  geom_vline(aes(xintercept = as.numeric(date.firstbillsign), 
                 text = "Governor signs first bill"), 
             col="blue", alpha=.8) +
  geom_vline(aes(xintercept = as.numeric(date.lastbillsign), 
                 text = "Governor signs last bill"), 
             col="blue", alpha=.8) +


  # zero axis
  geom_hline(yintercept = 0, col="grey") +
  
  labs(title = paste("Monthly fatalities with key dates:",
                     month.abb[start_mo], start_yr, " - ",
                     month.abb[last_complete_mo], max(index$year)),
       x = "Month/Year",
       y = "Number",
       caption = paste("WA since", params$startyr),
       fill = "Year") +
  
  ylim(c(-2, NA)) + # min needs to be < smoother lower se
  
  scale_x_continuous(
    breaks = df_by_month$index.date[seq(1, nrow(df_by_month), 6)], 
    label = df_by_month$mon.yr[seq(1, nrow(df_by_month), 6)])  +
  
  scale_y_continuous(breaks = c(0, 3, 6, 9)) +
  
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggplotly(p, tooltip = "text") %>% 
  style(hoverinfo = "y", traces = 2)
  
```

### This year vs. previous years

* The points show the monthly totals for each year. They are color coded to highlight the current year.

* The blue line shows the moving average for the monthly fatality rate for the `r params$startyr`-2020 period, and the grey shaded ribbon shows the 95% confidence band around that average.

* The black line shows the moving average for the monthly fatality rate for the current year. *When this line lies outside the grey ribbon for the blue line, this suggests the difference between this year and previous years is larger than normal variation would predict.*

* We only plot months once the data are complete, so the plot will lag 1-2 months behind the current date.  

* This is an interactive plot:  You can hover over points to get the month and year for each point.

```{r monthly, warning=F}
# we will only plot after current month has finished

# make sure the factor levels match
this.yr.color = c("lightsteelblue", "black")
names(this.yr.color) <- levels(df_by_month$this.yr)
this.yr.alpha = c(0.5, 1)
names(this.yr.alpha) <- levels(df_by_month$this.yr)

p <- ggplot(data = df_by_month,
            aes(x = mo, y = count)) +
  
  geom_jitter(aes(col = this.yr,
                  alpha = this.yr,
                  text = mon.yr),
              width = 0, height = .1) +
  scale_color_manual(name="Year", 
                     values=this.yr.color) +
  scale_alpha_manual(values=this.yr.alpha) +
  guides(alpha = "none") +
  
  geom_smooth(data = df_by_month %>% filter(year != max(year)),
              color = "lightsteelblue") +
  geom_smooth(data = df_by_month %>% filter(year == max(year)), se=F,
              color = "black") +
  
  scale_x_continuous(breaks = seq(1,12,1), 
                     label = month.abb) +
  
  labs(title = paste0("WA since ", params$startyr, 
                     ":  Monthly totals with moving average"),
       caption = paste("WA since", params$startyr)) +
  xlab("Month") +
  ylab("Number of people killed")


ggplotly(p, tooltip = "text")
  
```

## Annual totals {.tabset}

### By month and year

* The lines show the cumulative total fatalities by month as the year progresses, for each year. 

* We only plot months once the data are complete, so the plot will lag 1-2 months behind the current date.  

<!-- * This is an interactive plot:  You can hover over points to get the exact values for the cumulative number of cases for that month and year. -->

```{r cumulative, warning=F}
# plotly doesn't handle the multiple legend properly so we don't use it here

n.yrs <- max(index$year) - params$startyr + 1
yr.colors <- rev(RColorBrewer::brewer.pal(n.yrs+2, "Spectral"))[c(1:3, 6:9)]

this.yr.col <- c(n="#00000000", y="black")

ltyp = c("2021" = "solid")

df <- df_by_month %>%
  group_by(year) %>%
  mutate(cumulative = cumsum(count),
         mon = factor(mon, levels=month.abb))

ggplot(data= df %>% filter(year != max(df$year)),
       aes(x = mon, 
           y = cumulative, 
           color = factor(year),
           group = year)) +
  geom_line(size = 1.5, alpha = 1) +
  geom_point(aes(text = paste('Total =', cumulative, '<br>', 
                              mon, '<br>', year)),
                 size=1, alpha = 1) +
  scale_color_manual(values = yr.colors) +
  #scale_color_brewer(palette="Spectral") +

  geom_line(data = df %>% filter(year == max(df$year)),
            aes(x = mon, 
                y = cumulative,
                linetype = "2021",
                text = paste('Total =', cumulative, '<br>', 
                             mon, '<br>', year)),
            color = "black", size = 2, alpha = 0.7) +
  scale_linetype_manual(name = "This Yr", values = ltyp) +
  
  labs(title = paste0("WA since ", params$startyr,
                     ":  Cumulative fatalities by Month and Year"),
       caption = paste("WA since", params$startyr),
       color = "Previous Yrs") +
  xlab("Month") +
  ylab("Number of people killed") +
  guides(color = guide_legend(order = 1),
         linetype = guide_legend(order = 2))
  # + theme_bw()

#ggplotly(p, tooltip = "text")
  
```


### By COD

Here we plot the cumulative totals for year to date -- the count of total fatalities up to the *last complete month* of the current year, for each year.  

* We only plot months once the data are complete, so the plot will lag 1-2 months behind the current date.  

* The bars represent totals for year-to-date for each year, divided by cause of death:  gunshot, vehicle chase and all other causes.

* This is an interactive plot:  You can hover over bar segments to get the exact values for that cause of death in that year.


```{r annual, warning=F}
# Here we can't rely on index to restrict dates, so do it manually

p <-  homicides %>%
  filter(year >= params$startyr) %>%
  filter(match(month, month.abb) <= last_complete_mo) %>%
  mutate(cod = case_when(
    cod.fe == "Gunshot" ~ "shot", 
    cod.fe == "Vehicle" ~ "vehicle chase",
    TRUE ~ "other"),
    cod = factor(cod, levels = c("shot", "vehicle chase", "other")),
         year = as.character(year)) %>%
  group_by(year, cod) %>%
  summarize(n = n()) %>%
  mutate(percent = round(100*n / sum(n), 1)) %>%
  
  ggplot(aes(x = year,
             y = n,
             fill = cod, 
             text = paste0("N=", n, 
                           ", (", round(percent),"%)"))
         ) +
  
  geom_bar(stat="identity", alpha=.5,
           position = position_stack(reverse=T)) +
  scale_fill_manual(values = c("cadetblue","darkorange3", "goldenrod")) +
  
  labs(title = paste0("Fatalities Jan-", 
                      month.abb[last_complete_mo], 
                      " by Year"),
       caption = paste("WA since", params$startyr),
       x = "Year",
       y = "Number",
       fill = "Cause of\nDeath")

ggplotly(p, tooltip = "text")

```

### WA vs. all other states

Cumulative annual totals up to the last complete year, 
`r last_complete_yr`, with percentage change from 
`r last_complete_yr - 1` to `r last_complete_yr`. 

Here we report the results from the Fatal Encounters project and the Washington Post data separately.  Recall that Washington Post data only include persons shot and killed by police, while Fatal Encounters includes all persons who are killed by police (including deaths due to asphyxiation, tasers, vehicle chases, etc).

```{r wavsus, warning=F}
# Here we need the full FE and WaPo datasets, not just WA state

fe_tab <- fe_data %>% 
  filter(homicide==1 & year >= start_yr & year <= last_complete_yr) %>% 
  #filter(match(month, month.abb) <= last_fe_date - 1) %>%
  mutate(wa = ifelse(st == "WA", 1, 0)) %>%
  group_by(year, wa) %>%
  count() %>%
  pivot_wider(names_from = wa,
              values_from = n)
fe_tab <- rbind(fe_tab, 
                100*round(fe_tab[nrow(fe_tab),]/fe_tab[nrow(fe_tab)-1,]-1, 2)) %>%
  mutate(year = as.character(year))
fe_tab[nrow(fe_tab), 1] <- paste("Pct change", 
                                 last_complete_yr - 1,
                                 "to", last_complete_yr)

wapo_tab <- wapo_data %>% 
    filter(year >= start_yr & year <= last_complete_yr) %>%
  #filter(match(month, month.abb) <= last_wapo_date - 1) %>%
  mutate(wa = ifelse(st == "WA", 1, 0)) %>%
  group_by(year, wa) %>%
  count() %>%
  pivot_wider(names_from = wa,
              values_from = n)
wapo_tab <- rbind(wapo_tab, 
                100*round(wapo_tab[nrow(wapo_tab),]/wapo_tab[nrow(wapo_tab)-1,]-1, 2)) %>%
  mutate(year = as.character(year))
wapo_tab[nrow(wapo_tab), 1] <- paste("Pct change", 
                                     last_complete_yr - 1,
                                     "to", last_complete_yr)
```

Using Fatal Encounters data:

```{r wavsusfe, warning=F}
kable(fe_tab,
      caption = "Persons killed by police in FE: WA vs. all other states",
      col.names = c("Year", "All Other States", "WA")) %>%
  kable_styling(bootstrap_options = c("striped","hover"),
                full_width = F) %>%
  row_spec(nrow(fe_tab), bold = T) #%>%
  # add_footnote(label = "YTD counts:  Jan - Sep of each year",
  #              notation = "symbol")
```

Using Washington Post data:

```{r wavsuswapo, warning=F}
kable(wapo_tab,
      caption = "Persons shot by police in WaPo: WA vs. all other states",
      col.names = c("Year", "All Other States", "WA")) %>%
  kable_styling(bootstrap_options = c("striped","hover"),
                full_width = F) %>%
  row_spec(nrow(fe_tab), bold = T)  #%>%
  # add_footnote(label = "YTD counts:  Jan - Nov of each year",
  #              notation = "symbol")
```

# Say their names {.tabset}

## Name known

Of the `r last.case` persons killed by police, 
`r table(homicides$name != "Unknown")[[2]]` 
of the victim's names are known at this time.

```{r names}

homicides %>%
  filter(name != "Unknown") %>%
  select(name, date, age=age, county, agency, url = url_click) %>%
  arrange(desc(date)) %>%
  DT::datatable(rownames = F,
                caption = paste("The Names We Know:  as of", scrape_date),
                filter = 'top',
                escape = FALSE)

```

## Name Unknown

The remaining 
`r (last.case-table(homicides$name != "Unknown")[[2]])` 
of the victim's names are not known at this time.

```{r namesUnk}
homicides %>%
  filter(name == "Unknown") %>%
  select(name, date, age=age, county, agency, url = url_click) %>%
  arrange(desc(date)) %>%
  DT::datatable(rownames = F,
                caption = paste("The Names We Don't Know:  as of", scrape_date),
                filter = 'top',
                escape = FALSE)
```

# Datasets: discussion

```{r datasets, child='./Common/datasetDiscussion.Rmd'}
```
